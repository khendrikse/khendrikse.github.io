<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><script type="application/ld+json">{&quot;@context&quot;:&quot;https://schema.org&quot;,&quot;@type&quot;:&quot;BlogPosting&quot;,&quot;mainEntityOfPage&quot;:{&quot;@type&quot;:&quot;WebPage&quot;,&quot;@id&quot;:&quot;https://khendrikse.github.io/nextjs-auth-with-httponly-cookies-incl-refresh&quot;},&quot;headline&quot;:&quot;Authenticate third-party API&#x27;s in Next.js using HttpOnly cookies and axios interceptors&quot;,&quot;description&quot;:&quot;How to store third-party API tokens using HttpOnly, including refreshing tokens using axios request interceptors.&quot;,&quot;image&quot;:&quot;https://khendrikse.github.io/_next/static/chunks/images/2022-02-21-a75a39c7f14850cc4cdf9e10a5fc635f.jpg&quot;,&quot;datePublished&quot;:&quot;February 21, 2022&quot;,&quot;dateModified&quot;:&quot;February 21, 2022&quot;,&quot;author&quot;:{&quot;@type&quot;:&quot;Person&quot;,&quot;name&quot;:&quot;Karin Hendrikse&quot;,&quot;url&quot;:&quot;https://khendrikse.github.io/about&quot;}}</script><script type="application/ld+json">{&quot;@context&quot;:&quot;https://schema.org/&quot;,&quot;@type&quot;:&quot;BreadcrumbList&quot;,&quot;itemListElement&quot;:[{&quot;@type&quot;:&quot;ListItem&quot;,&quot;position&quot;:1,&quot;name&quot;:&quot;home&quot;,&quot;item&quot;:&quot;https://khendrikse.github.io/&quot;},{&quot;@type&quot;:&quot;ListItem&quot;,&quot;position&quot;:2,&quot;name&quot;:&quot;blog&quot;,&quot;item&quot;:&quot;https://khendrikse.github.io/blog/&quot;},{&quot;@type&quot;:&quot;ListItem&quot;,&quot;position&quot;:3,&quot;name&quot;:&quot;Authenticate third-party API&#x27;s in Next.js using HttpOnly cookies and axios interceptors&quot;,&quot;item&quot;:&quot;https://khendrikse.github.io/blog/nextjs-auth-with-httponly-cookies-incl-refresh&quot;}]}</script><title>Authenticate third-party API&#x27;s in Next.js using HttpOnly...</title><meta name="twitter:title" content="Authenticate third-party API&#x27;s in Next.js using HttpOnly cookies an..."/><meta property="og:title" content="Authenticate third-party API&#x27;s in Next.js using HttpOnly cookies and axios interceptors..."/><meta name="description" content="How to store third-party API tokens using HttpOnly, including refreshing tokens using axios request interceptors."/><meta name="twitter:description" content="How to store third-party API tokens using HttpOnly, including refreshing tokens using axios request interceptors."/><meta property="og:description" content="How to store third-party API tokens using HttpOnly, including refreshing tokens using axios request interceptors."/><meta name="twitter:site" content="@k_henhey"/><meta name="twitter:creator" content="@k_henhey"/><meta name="twitter:card" content="summary"/><meta property="og:type" content="article"/><meta property="og:url" content="https://khendrikse.github.io/blog/nextjs-auth-with-httponly-cookies-incl-refresh"/><meta name="twitter:image" content="https://khendrikse.github.io/_next/static/chunks/images/2022-02-21-a75a39c7f14850cc4cdf9e10a5fc635f.jpg"/><meta property="og:image" content="https://khendrikse.github.io/_next/static/chunks/images/2022-02-21-a75a39c7f14850cc4cdf9e10a5fc635f.jpg"/><meta name="twitter:image:alt" content="a cat taking a very cozy nap"/><meta name="next-head-count" content="18"/><link rel="icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text y=%22.9em%22 font-size=%2290%22&gt;ðŸŒ±&lt;/text&gt;&lt;/svg&gt;"/><script data-goatcounter="https://khdev.goatcounter.com/count" async="" src="//gc.zgo.at/count.js"></script><link rel="preload" href="/_next/static/css/95df6376c575c08c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/95df6376c575c08c.css" data-n-g=""/><link rel="preload" href="/_next/static/css/cd72f785afe8166e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/cd72f785afe8166e.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-44197c38ec1603f8.js" defer=""></script><script src="/_next/static/chunks/framework-433e73989db4e225.js" defer=""></script><script src="/_next/static/chunks/main-0678d5b1b4679bdc.js" defer=""></script><script src="/_next/static/chunks/pages/_app-f723873558ff9929.js" defer=""></script><script src="/_next/static/chunks/d0447323-f8acf20273622023.js" defer=""></script><script src="/_next/static/chunks/0c428ae2-59051706ed2820c0.js" defer=""></script><script src="/_next/static/chunks/743-4da58bd1b048f991.js" defer=""></script><script src="/_next/static/chunks/603-dcb55c59b62ae9ee.js" defer=""></script><script src="/_next/static/chunks/580-adaf663db4ce4709.js" defer=""></script><script src="/_next/static/chunks/541-5357fe72de885bc6.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bpostname%5D-c8d6268488beb939.js" defer=""></script><script src="/_next/static/OhLvGett58GshWm6RiLAE/_buildManifest.js" defer=""></script><script src="/_next/static/OhLvGett58GshWm6RiLAE/_ssgManifest.js" defer=""></script><script src="/_next/static/OhLvGett58GshWm6RiLAE/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="wrapper"><section class="layout"><header><nav class="navbar_navbar__lC1dX"><div class="navbar_navbar__inner__u9kLF"><h1 class="navbar_navbar__title__oKE_L"><a href="/">Karin Hendrikse</a></h1><ul class="navbar_navbar__menu__XlTKp"><li><a class="navbar_navbar__menu__item__6e5_F" href="/about">About</a></li><li><a class="navbar_navbar__menu__item__6e5_F" href="/blog">Blog</a></li><li><a class="navbar_navbar__menu__item__6e5_F" href="/projects">Projects</a></li><li><a class="navbar_navbar__menu__item__6e5_F" href="/">Home</a></li><li><a class="navbar_navbar__menu__icon__cKwHu" aria-label="RSS feed" href="https://khendrikse.github.io/feeds/feed.xml"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="14px" width="14px" xmlns="http://www.w3.org/2000/svg"><title>RSS</title><path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2zm1.5 2.5c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1 0-2zm0 4a6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1 0-2zm.5 7a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"></path></svg></a></li></ul></div></nav></header><div class="content"><article><img class="post_post__header__image__F9dvV" src="data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAHAAoDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAUH/8QAHhAAAgICAgMAAAAAAAAAAAAAAQIDBAARBiEFE4H/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAv/EABcRAQEBAQAAAAAAAAAAAAAAAAECAAP/2gAMAwEAAhEDEQA/ANG8Jye1NNcR7JDNIFrq0Y9ahT3vXZ38OWJOT0A7BmTYJB1G2MYnrQa2Df/Z" alt="a cat taking a very cozy nap" style="transition:0.2s filter linear;filter:blur(20px)"/><div class="container"><div class="post_post__header__title__nmuW6"><h2>Authenticate third-party API&#x27;s in Next.js using HttpOnly cookies and axios interceptors</h2><div class="post_post__date_label__jb050">February 21, 2022</div></div></div><div class="post_post__body__Iz5iR"><div class="container"><div class="post_post__intro__JzsWI"></div><p><em>It&#x27;s the beginning of 2022, and before I dive into this tech filled post, I just wanted to start off cozy and calm. With this amazing picture by Aleksandar Cvetianovic. Take it in. Breathe... and let&#x27;s go.</em></p>
<p>Photo by <a href="https://unsplash.com/@lemonzandtea?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Aleksandar Cvetanovic</a> on <a href="https://unsplash.com/s/photos/cozy?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></p>
<h2>TL;DR</h2>
<p>In this article, we&#x27;re going to look into storing and managing refreshing authentication tokens from third-party API&#x27;s using Next.js. We&#x27;ll use <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#restrict_access_to_cookies">HttpOnly cookies</a> and deal with expiring tokens using <a href="https://axios-http.com/docs/interceptors">axios interceptors</a>. Scroll down to &quot;The setup&quot; for all the details.</p>
<h2>Background</h2>
<p>Last year I was working on a personal project where I was using a third-party API. I researched ways in which I could store the user access token <strong>without</strong> having to create my own database. One of the possibilities was using HttpOnly cookies. I had already decided to go for Next.js because of the quick server setup that comes with it. I implemented the authentication flow and searched for the logic to refresh tokens. This is how I solved it:</p>
<h2>The setup</h2>
<h3>Preface</h3>
<p>To follow along, you need to already know how to do the following:</p>
<ul>
<li><a href="https://nextjs.org/docs/getting-started">set up a Next.js project</a></li>
<li>authenticate the third-party API you&#x27;re going to use through <a href="https://nextjs.org/docs/api-routes/introduction">Next.js API routes</a>.</li>
<li>understand the logic to refresh your tokens for your third-party API.</li>
</ul>
<h3>Storing your refresh token inside a HttpOnly cookie</h3>
<p>To securely store the third-party API refresh token, we&#x27;ll use a HttpOnly cookie. To read more about the security they can provide, <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#restrict_access_to_cookies">check out the docs at MDN.</a>.</p>
<blockquote>
<p><strong>To figure out yourself:</strong></p>
<p>To start, make sure you have your Next.js project setup with a server that manages getting the refresh token from your third-party API. I&#x27;m assuming you&#x27;ve created your own endpoint in the <code>pages/api</code> folder. For this example, I&#x27;ll call the file <code>getRefreshToken.js</code>.</p>
</blockquote>
<p>We&#x27;re going to use the <a href="https://www.npmjs.com/package/cookie">cookie</a> library to help deal with setting our cookie. To add it to our project:</p>
<pre><pre style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;position:relative;margin:0.5em 0;padding:1.25em 1em"><code class="language-shell" style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>$ </span><span class="token token" style="color:#c792ea">npm</span><span> </span><span class="token token" style="color:#c792ea">install</span><span> cookie
</span>
<!-- -->// or
<!-- -->
<span>$ </span><span class="token token" style="color:#c792ea">yarn</span><span> </span><span class="token token" style="color:#c792ea">add</span><span> cookie
</span>
</code></pre></pre>
<p>We will create our cookie in the <code>getRefreshToken.js</code> file. After getting your refresh token, use the <code>res</code> parameter that is exposed from the request handler in the <code>get-token</code> endpoint.</p>
<pre><pre style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;position:relative;margin:0.5em 0;padding:1.25em 1em"><code class="language-js" style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#546e7a">// pages/api/getRefreshToken.js</span><span>
</span>
<span></span><span class="token token" style="color:#546e7a">// --- all the logic you wrote yourself to get the refresh_token</span><span>
</span>
<span>res</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">setHeader</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c3e88d">&#x27;Set-Cookie&#x27;</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#89ddff">[</span><span>
</span><span>  cookie</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">serialize</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c3e88d">&#x27;refreshToken&#x27;</span><span class="token token" style="color:#89ddff">,</span><span> refresh_token</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>    httpOnly</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#c792ea">true</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>    secure</span><span class="token token" style="color:#89ddff">:</span><span> process</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">env</span><span class="token token" style="color:#89ddff">.</span><span class="token token" style="color:#c792ea">NODE_ENV</span><span> </span><span class="token token" style="color:#89ddff">!==</span><span> </span><span class="token token" style="color:#c3e88d">&#x27;development&#x27;</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>    maxAge</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#fd9170">60</span><span> </span><span class="token token" style="color:#89ddff">*</span><span> </span><span class="token token" style="color:#fd9170">60</span><span> </span><span class="token token" style="color:#89ddff">*</span><span> </span><span class="token token" style="color:#fd9170">24</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>    sameSite</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#c3e88d">&#x27;strict&#x27;</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>    path</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#c3e88d">&#x27;/&#x27;</span><span>
</span><span>  </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span></span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span></code></pre></pre>
<p>To enable the cookie as HttpOnly, we set <code>httpOnly: true</code>. To only allow access through HTTPS protocol, add <code>secure: process.env.NODE_ENV !== &#x27;development&#x27;</code>. Currently, HTTPS is usually not used on <code>localhost</code>, so we set it up to only use <code>secure: true</code> on production. If you&#x27;re curious about this, you can <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#restrict_access_to_cookies">read up on it on MDN</a>.</p>
<p>Set <code>maxAge: 60 * 60 * 24</code>, to define the amount of seconds before the cookie expires. In this case it sets it to 24 hours. This will force the token to be invalidated after 24 hours.</p>
<p>Eventually the endpoint will look something like this:</p>
<pre><pre style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;position:relative;margin:0.5em 0;padding:1.25em 1em"><code class="language-js" style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#546e7a">// pages/api/getRefreshToken.js</span><span>
</span><span></span><span class="token token module" style="color:#c792ea;font-style:italic">import</span><span> </span><span class="token token imports">axios</span><span> </span><span class="token token module" style="color:#c792ea;font-style:italic">from</span><span> </span><span class="token token" style="color:#c3e88d">&#x27;axios&#x27;</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span></span><span class="token token module" style="color:#c792ea;font-style:italic">import</span><span> </span><span class="token token imports">cookie</span><span> </span><span class="token token module" style="color:#c792ea;font-style:italic">from</span><span> </span><span class="token token" style="color:#c3e88d">&#x27;cookie&#x27;</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span></span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token function-variable" style="color:#c792ea">getRefreshToken</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea;font-style:italic">async</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">req</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> res</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>  </span><span class="token token" style="color:#546e7a">// we use this &#x27;res&#x27; parameter to set the cookie.</span><span>
</span>
<span>  </span><span class="token token" style="color:#546e7a">// any logic you need to get your refresh token, including</span><span>
</span>
<span>  </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> options </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>    </span><span class="token token" style="color:#546e7a">// all necessary options for getting the refresh token</span><span>
</span><span>  </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span>  </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token function-variable" style="color:#c792ea">fetchData</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span>
</span><span>    </span><span class="token token" style="color:#c792ea">axios</span><span class="token token" style="color:#89ddff">(</span><span>options</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>      </span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">then</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c792ea;font-style:italic">async</span><span> </span><span class="token token parameter">response</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>        </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token" style="color:#89ddff">{</span><span> refresh_token </span><span class="token token" style="color:#89ddff">}</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> response</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">data</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span>        res</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">setHeader</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c3e88d">&#x27;Set-Cookie&#x27;</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#89ddff">[</span><span>
</span><span>          cookie</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">serialize</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c3e88d">&#x27;refreshToken&#x27;</span><span class="token token" style="color:#89ddff">,</span><span> refresh_token</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>            httpOnly</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#c792ea">true</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>            secure</span><span class="token token" style="color:#89ddff">:</span><span> process</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">env</span><span class="token token" style="color:#89ddff">.</span><span class="token token" style="color:#c792ea">NODE_ENV</span><span> </span><span class="token token" style="color:#89ddff">!==</span><span> </span><span class="token token" style="color:#c3e88d">&#x27;development&#x27;</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>            maxAge</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#fd9170">60</span><span> </span><span class="token token" style="color:#89ddff">*</span><span> </span><span class="token token" style="color:#fd9170">60</span><span> </span><span class="token token" style="color:#89ddff">*</span><span> </span><span class="token token" style="color:#fd9170">24</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>            sameSite</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#c3e88d">&#x27;strict&#x27;</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>            path</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#c3e88d">&#x27;/&#x27;</span><span>
</span><span>          </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span>        res</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">statusCode</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#fd9170">200</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>        res</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">setHeader</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c3e88d">&#x27;Content-Type&#x27;</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#c3e88d">&#x27;application/json&#x27;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>        res</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">end</span><span class="token token" style="color:#89ddff">(</span><span class="token token known-class-name" style="color:#f2ff00">JSON</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">stringify</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">{</span><span> refresh_token </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>      </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>      </span><span class="token token" style="color:#89ddff">.</span><span class="token token control-flow" style="color:#c792ea;font-style:italic">catch</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">error</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>        </span><span class="token token" style="color:#546e7a">// logic for handling errors</span><span>
</span><span>      </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span>  </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">await</span><span> </span><span class="token token" style="color:#c792ea">fetchData</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span></span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span></span><span class="token token module" style="color:#c792ea;font-style:italic">export</span><span> </span><span class="token token module" style="color:#c792ea;font-style:italic">default</span><span> getRefreshToken</span><span class="token token" style="color:#89ddff">;</span></code></pre></pre>
<p>If you ever want to use this cookie, you can find it on the <code>req</code> object on any call to your Next.js server. It will be available in <code>req.cookies</code>.</p>
<h3>Encrypting our refresh token</h3>
<p>Because a refresh token is an important part of the authentication flow, we&#x27;ll add an extra layer of security by encrypting it. We will use the library <a href="https://www.npmjs.com/package/crypto-js"><code>crypto-js</code></a> for this. This library can help us encrypt our token using an &#x27;encryption key&#x27; or password. This password will only be available to our server. This way the server is able to encrypt and decrypt the token.</p>
<pre><pre style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;position:relative;margin:0.5em 0;padding:1.25em 1em"><code class="language-shell" style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>$ </span><span class="token token" style="color:#c792ea">npm</span><span> </span><span class="token token" style="color:#c792ea">install</span><span> crypto-js
</span>
<!-- -->// or
<!-- -->
<span>$ </span><span class="token token" style="color:#c792ea">yarn</span><span> </span><span class="token token" style="color:#c792ea">add</span><span> crypto-js
</span>
</code></pre></pre>
<p>In our <code>env.local</code> file (which we do not commit!) we add an environment variable with a encryption key of approximately 32 characters. Make sure this key is truly secret, random and secure!</p>
<pre><pre style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;position:relative;margin:0.5em 0;padding:1.25em 1em"><code class="language-env" style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>// .env.local
</span>ENCRYPT_KEY=theverylongpasswordwith32characters
</code></pre></pre>
<p>In the <code>getRefreshToken.js</code> file, import <code>AES</code> from <code>crypto-js/aes</code>. In the object where we set <code>refreshToken</code>, use the <code>encode</code> key in the cookie object to pass the function that will encrypt the token:</p>
<pre><pre style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;position:relative;margin:0.5em 0;padding:1.25em 1em"><code class="language-js" style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#546e7a">// pages/api/getRefreshToken.js</span><span>
</span>
<span></span><span class="token token module" style="color:#c792ea;font-style:italic">import</span><span> </span><span class="token token" style="color:#c792ea">AES</span><span> </span><span class="token token module" style="color:#c792ea;font-style:italic">from</span><span> </span><span class="token token" style="color:#c3e88d">&#x27;crypto-js/aes&#x27;</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span></span><span class="token token" style="color:#546e7a">// ...</span><span>
</span>
<span>cookie</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">serialize</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c3e88d">&#x27;refreshToken&#x27;</span><span class="token token" style="color:#89ddff">,</span><span> refresh_token</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>  httpOnly</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#c792ea">true</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>  secure</span><span class="token token" style="color:#89ddff">:</span><span> process</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">env</span><span class="token token" style="color:#89ddff">.</span><span class="token token" style="color:#c792ea">NODE_ENV</span><span> </span><span class="token token" style="color:#89ddff">!==</span><span> </span><span class="token token" style="color:#c3e88d">&#x27;development&#x27;</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>  maxAge</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#fd9170">60</span><span> </span><span class="token token" style="color:#89ddff">*</span><span> </span><span class="token token" style="color:#fd9170">60</span><span> </span><span class="token token" style="color:#89ddff">*</span><span> </span><span class="token token" style="color:#fd9170">24</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>  sameSite</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#c3e88d">&#x27;strict&#x27;</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>  path</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#c3e88d">&#x27;/&#x27;</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>  </span><span class="token token function-variable" style="color:#c792ea">encode</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token parameter">value</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#c792ea">AES</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">encrypt</span><span class="token token" style="color:#89ddff">(</span><span>value</span><span class="token token" style="color:#89ddff">,</span><span> process</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">env</span><span class="token token" style="color:#89ddff">.</span><span class="token token" style="color:#c792ea">ENCRYPT_KEY</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">toString</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span></span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span></code></pre></pre>
<p>Whenever you want to use this token you do need to decrypt it using the encryption key like so:</p>
<pre><pre style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;position:relative;margin:0.5em 0;padding:1.25em 1em"><code class="language-js" style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token module" style="color:#c792ea;font-style:italic">import</span><span> </span><span class="token token imports maybe-class-name">CryptoJS</span><span> </span><span class="token token module" style="color:#c792ea;font-style:italic">from</span><span> </span><span class="token token" style="color:#c3e88d">&#x27;crypto-js&#x27;</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span></span><span class="token token" style="color:#546e7a">// In the place where you use your refresh token:</span><span>
</span><span></span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token" style="color:#89ddff">{</span><span> refreshToken </span><span class="token token" style="color:#89ddff">}</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> req</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">cookies</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span></span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> decryptedRefresh </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token maybe-class-name">CryptoJS</span><span class="token token" style="color:#89ddff">.</span><span class="token token" style="color:#c792ea">AES</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">decrypt</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>  refreshToken</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>  process</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">env</span><span class="token token" style="color:#89ddff">.</span><span class="token token" style="color:#c792ea">ENCRYPT_KEY</span><span>
</span><span></span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">toString</span><span class="token token" style="color:#89ddff">(</span><span class="token token maybe-class-name">CryptoJS</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">enc</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access maybe-class-name">Utf8</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span></code></pre></pre>
<h3>Setting up an axios instance to manage refresh tokens</h3>
<p>Whenever a token expires or is incorrect, we&#x27;ll try and refresh them. Usually, in the cases that this happens, an API would return <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/401"><code>401 Unauthorized</code></a>.</p>
<p>To deal with this we&#x27;re going to use <a href="https://axios-http.com/docs/interceptors">axios Interceptors</a>.</p>
<p>You can use an interceptor to &#x27;intercept&#x27; requests or responses before they are actually handled. In this example we&#x27;re going to:</p>
<ul>
<li>Create our own axios instance and add a request and response interceptor to it.</li>
<li>Use this axios instance everywhere we are doing calls that use an access token.</li>
</ul>
<p>This way, if an endpoint is using an access token to get data, and receives an <code>401 Unauthorized</code>, we can handle this by refreshing the token. Let&#x27;s break this down:</p>
<p>Create your own axios instance inside a file called <code>axios-instance.js</code>:</p>
<pre><pre style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;position:relative;margin:0.5em 0;padding:1.25em 1em"><code class="language-js" style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#546e7a">// axios-instance.js</span><span>
</span><span></span><span class="token token module" style="color:#c792ea;font-style:italic">import</span><span> </span><span class="token token imports">axios</span><span> </span><span class="token token module" style="color:#c792ea;font-style:italic">from</span><span> </span><span class="token token" style="color:#c3e88d">&#x27;axios&#x27;</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span></span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> axiosInstance </span><span class="token token" style="color:#89ddff">=</span><span> axios</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">create</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span></span><span class="token token module" style="color:#c792ea;font-style:italic">export</span><span> </span><span class="token token module" style="color:#c792ea;font-style:italic">default</span><span> axiosInstance</span><span class="token token" style="color:#89ddff">;</span></code></pre></pre>
<p>To add our interceptor logic we&#x27;ll start with the response interceptor. Whenever we get a response from an API we check if it is <code>401 Unauthorized</code>. If that is the case we refresh the access token and try the call again. To do this we&#x27;ll be using <a href="https://www.npmjs.com/package/axios-auth-refresh">axios-auth-refresh</a> which makes it really easy to set this up.</p>
<p>Add the library:</p>
<pre><pre style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;position:relative;margin:0.5em 0;padding:1.25em 1em"><code class="language-js" style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>npm install </span><span class="token token" style="color:#c3e88d">&#x27;axios-auth-refresh&#x27;</span><span>
</span>
<span></span><span class="token token" style="color:#546e7a">// or</span><span>
</span>
<span>yarn add </span><span class="token token" style="color:#c3e88d">&#x27;axios-auth-refresh&#x27;</span><span>
</span>
</code></pre></pre>
<p>Inside the <code>axios-instance.js</code> file, import <code>createAuthRefreshInterceptor</code>. Then create a <code>refreshAuthLogic</code> function. This function has a failedRequest parameter that we receive from our interceptor.</p>
<blockquote>
<p><strong>To figure out yourself:</strong></p>
<p>Now it&#x27;s up to you to create a function we can call that handles refreshing the access token from your third-party API. You can grab the refresh token from <code>req.cookies</code>. Don&#x27;t forget to decrypt it like I showed you before! And make sure it returns the access token <strong>without</strong> encryption.</p>
</blockquote>
<p>Inside <code>refreshAuthLogic</code> we will use the refresh function you created yourself, in this example it&#x27;s called <code>refreshAccessToken</code>. That function returns our new token, which we set as the response Authorization header. Finally, we return a resolved promise.</p>
<p>We then call the <code>createAuthRefreshInterceptor</code> function and pass in the <code>axiosInstance</code> and <code>refreshAuthLogic</code> function we created.</p>
<pre><pre style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;position:relative;margin:0.5em 0;padding:1.25em 1em"><code class="language-js" style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#546e7a">// axios-instance.js</span><span>
</span><span></span><span class="token token module" style="color:#c792ea;font-style:italic">import</span><span> </span><span class="token token imports">axios</span><span> </span><span class="token token module" style="color:#c792ea;font-style:italic">from</span><span> </span><span class="token token" style="color:#c3e88d">&#x27;axios&#x27;</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span></span><span class="token token module" style="color:#c792ea;font-style:italic">import</span><span> </span><span class="token token imports">createAuthRefreshInterceptor</span><span> </span><span class="token token module" style="color:#c792ea;font-style:italic">from</span><span> </span><span class="token token" style="color:#c3e88d">&#x27;axios-auth-refresh&#x27;</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span></span><span class="token token module" style="color:#c792ea;font-style:italic">import</span><span> </span><span class="token token imports">refreshAccessToken</span><span> </span><span class="token token module" style="color:#c792ea;font-style:italic">from</span><span> </span><span class="token token" style="color:#c3e88d">&#x27;./refresh-access-token&#x27;</span><span class="token token" style="color:#89ddff">;</span><span> </span><span class="token token" style="color:#546e7a">// this file contains any logic you need to refresh your token with your third-party API</span><span>
</span>
<span></span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> axiosInstance </span><span class="token token" style="color:#89ddff">=</span><span> axios</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">create</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span></span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token function-variable" style="color:#c792ea">refreshAuthLogic</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token parameter">failedRequest</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span>
</span><span>  </span><span class="token token" style="color:#c792ea">refreshAccessToken</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">then</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">tokenRefreshResponse</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>    </span><span class="token token" style="color:#546e7a">// get the new token</span><span>
</span><span>    failedRequest</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">response</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">config</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">headers</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access maybe-class-name">Authorization</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token template-string template-punctuation" style="color:#c3e88d">`</span><span class="token token template-string" style="color:#c3e88d">Bearer </span><span class="token token template-string interpolation interpolation-punctuation" style="color:#89ddff">${</span><span class="token token template-string interpolation">tokenRefreshResponse</span><span class="token token template-string interpolation" style="color:#89ddff">.</span><span class="token token template-string interpolation property-access">accessToken</span><span class="token token template-string interpolation interpolation-punctuation" style="color:#89ddff">}</span><span class="token token template-string template-punctuation" style="color:#c3e88d">`</span><span class="token token" style="color:#89ddff">;</span><span> </span><span class="token token" style="color:#546e7a">// set the new token as the authorization header.</span><span>
</span><span>    </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token known-class-name" style="color:#f2ff00">Promise</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">resolve</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>  </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span></span><span class="token token" style="color:#c792ea">createAuthRefreshInterceptor</span><span class="token token" style="color:#89ddff">(</span><span>axiosInstance</span><span class="token token" style="color:#89ddff">,</span><span> refreshAuthLogic</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span></span><span class="token token module" style="color:#c792ea;font-style:italic">export</span><span> </span><span class="token token module" style="color:#c792ea;font-style:italic">default</span><span> axiosInstance</span><span class="token token" style="color:#89ddff">;</span></code></pre></pre>
<blockquote>
<p><strong>To figure out yourself:</strong></p>
<p>Something to keep in mind for the <code>refreshAccessToken</code> logic that you&#x27;ll be creating yourself to get your refreshed token, is that you&#x27;re going to have to make sure you also set this new refresh token as a cookie. You can use the same logic as we have used before for that.</p>
</blockquote>
<p>Now let&#x27;s deal with the request interceptors. This is where the fun starts.</p>
<p>Inside our <code>axios-instance.js</code> file, we&#x27;re going to create a <code>let requestToken;</code> empty variable. Then inside <code>refreshAuthLogic</code>, we assign the refreshed token to <code>requestToken</code>. This way, <code>requestToken</code> will always be up to date with the latest version of our token.</p>
<p>After this we&#x27;re going to set our own request interceptor. We tell it to check if <code>requestToken</code> is empty or not. If it is empty, we&#x27;ll use the <code>refreshAccessToken</code> function to get a new token. If it is not empty, we use <code>requestToken</code> as our authorization header:</p>
<pre><pre style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;position:relative;margin:0.5em 0;padding:1.25em 1em"><code class="language-js" style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#546e7a">// axios-instance.js</span><span>
</span><span></span><span class="token token module" style="color:#c792ea;font-style:italic">import</span><span> </span><span class="token token imports">axios</span><span> </span><span class="token token module" style="color:#c792ea;font-style:italic">from</span><span> </span><span class="token token" style="color:#c3e88d">&#x27;axios&#x27;</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span></span><span class="token token module" style="color:#c792ea;font-style:italic">import</span><span> </span><span class="token token imports">createAuthRefreshInterceptor</span><span> </span><span class="token token module" style="color:#c792ea;font-style:italic">from</span><span> </span><span class="token token" style="color:#c3e88d">&#x27;axios-auth-refresh&#x27;</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span></span><span class="token token module" style="color:#c792ea;font-style:italic">import</span><span> </span><span class="token token imports">refreshAccessToken</span><span> </span><span class="token token module" style="color:#c792ea;font-style:italic">from</span><span> </span><span class="token token" style="color:#c3e88d">&#x27;./refresh-access-token&#x27;</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span></span><span class="token token" style="color:#c792ea;font-style:italic">let</span><span> requestToken</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span></span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> axiosInstance </span><span class="token token" style="color:#89ddff">=</span><span> axios</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">create</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span></span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token function-variable" style="color:#c792ea">refreshAuthLogic</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token parameter">failedRequest</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span>
</span><span>  </span><span class="token token" style="color:#c792ea">refreshAccessToken</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">then</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">tokenRefreshResponse</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>    failedRequest</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">response</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">config</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">headers</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access maybe-class-name">Authorization</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token template-string template-punctuation" style="color:#c3e88d">`</span><span class="token token template-string" style="color:#c3e88d">Bearer </span><span class="token token template-string interpolation interpolation-punctuation" style="color:#89ddff">${</span><span class="token token template-string interpolation">tokenRefreshResponse</span><span class="token token template-string interpolation" style="color:#89ddff">.</span><span class="token token template-string interpolation property-access">accessToken</span><span class="token token template-string interpolation interpolation-punctuation" style="color:#89ddff">}</span><span class="token token template-string template-punctuation" style="color:#c3e88d">`</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>    requestToken </span><span class="token token" style="color:#89ddff">=</span><span> tokenRefreshResponse</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">accessToken</span><span class="token token" style="color:#89ddff">;</span><span> </span><span class="token token" style="color:#546e7a">// change the requestToken with the refreshed one</span><span>
</span><span>    </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token known-class-name" style="color:#f2ff00">Promise</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">resolve</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>  </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span></span><span class="token token" style="color:#c792ea">createAuthRefreshInterceptor</span><span class="token token" style="color:#89ddff">(</span><span>axiosInstance</span><span class="token token" style="color:#89ddff">,</span><span> refreshAuthLogic</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span>axiosInstance</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">interceptors</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">request</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">use</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c792ea;font-style:italic">async</span><span> </span><span class="token token parameter">request</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>  </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">if</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">!</span><span>requestToken</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>    </span><span class="token token" style="color:#c792ea">refreshAccessToken</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">then</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">tokenRefreshResponse</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>      requestToken </span><span class="token token" style="color:#89ddff">=</span><span> tokenRefreshResponse</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">accessToken</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>    </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>  </span><span class="token token" style="color:#89ddff">}</span><span>
</span>
<span>  request</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">headers</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access maybe-class-name">Authorization</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token template-string template-punctuation" style="color:#c3e88d">`</span><span class="token token template-string" style="color:#c3e88d">Bearer </span><span class="token token template-string interpolation interpolation-punctuation" style="color:#89ddff">${</span><span class="token token template-string interpolation">requestToken</span><span class="token token template-string interpolation interpolation-punctuation" style="color:#89ddff">}</span><span class="token token template-string template-punctuation" style="color:#c3e88d">`</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>  </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> request</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span></span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span></span><span class="token token module" style="color:#c792ea;font-style:italic">export</span><span> </span><span class="token token module" style="color:#c792ea;font-style:italic">default</span><span> axiosInstance</span><span class="token token" style="color:#89ddff">;</span></code></pre></pre>
<p>From this point on, any request that is made using the axios instance, will grab the authorization token from the <code>let requestToken</code> in this file <em>before</em> doing a request. So if an earlier request refreshed the token, the next one is able to use the refreshed one. And that&#x27;s it!</p></div></div></article></div></section></div><div class="footer_footer__7PBRV"><div class="footer_footer__links__Z7tzO"><a class="footer_footer__link__VHWPt" aria-label="GitHub" href="https://github.com/khendrikse"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="24px" width="24px" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg></a><a class="footer_footer__link__VHWPt" aria-label="linkedin" href="https://www.linkedin.com/in/karinhendrikse/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="24px" width="24px" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"></path></svg></a><a class="footer_footer__link__VHWPt" aria-label="Twitter" href="https://twitter.com/k_henhey"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="24px" width="24px" xmlns="http://www.w3.org/2000/svg"><title>Twitter</title><path d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z"></path></svg></a><a class="footer_footer__link__VHWPt" aria-label="DEV.to" href="https://dev.to/khenhey"><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" height="24px" width="24px" xmlns="http://www.w3.org/2000/svg"><title>DEV.to</title><title></title><path d="M7.42 10.05c-.18-.16-.46-.23-.84-.23H6l.02 2.44.04 2.45.56-.02c.41 0 .63-.07.83-.26.24-.24.26-.36.26-2.2 0-1.91-.02-1.96-.29-2.18zM0 4.94v14.12h24V4.94H0zM8.56 15.3c-.44.58-1.06.77-2.53.77H4.71V8.53h1.4c1.67 0 2.16.18 2.6.9.27.43.29.6.32 2.57.05 2.23-.02 2.73-.47 3.3zm5.09-5.47h-2.47v1.77h1.52v1.28l-.72.04-.75.03v1.77l1.22.03 1.2.04v1.28h-1.6c-1.53 0-1.6-.01-1.87-.3l-.3-.28v-3.16c0-3.02.01-3.18.25-3.48.23-.31.25-.31 1.88-.31h1.64v1.3zm4.68 5.45c-.17.43-.64.79-1 .79-.18 0-.45-.15-.67-.39-.32-.32-.45-.63-.82-2.08l-.9-3.39-.45-1.67h.76c.4 0 .75.02.75.05 0 .06 1.16 4.54 1.26 4.83.04.15.32-.7.73-2.3l.66-2.52.74-.04c.4-.02.73 0 .73.04 0 .14-1.67 6.38-1.8 6.68z"></path></svg></a><a class="footer_footer__link__VHWPt" aria-label="RSS feed" href="https://khendrikse.github.io/feeds/feed.xml"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="24px" width="24px" xmlns="http://www.w3.org/2000/svg"><title>RSS</title><path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2zm1.5 2.5c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1 0-2zm0 4a6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1 0-2zm.5 7a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"></path></svg></a>Â© <!-- -->2022<!-- --> Karin Hendrikse</div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"siteTitle":"Karin Hendrikse","frontmatter":{"layout":"post","title":"Authenticate third-party API's in Next.js using HttpOnly cookies and axios interceptors","published":true,"date":"2022-02-21","description":"How to store third-party API tokens using HttpOnly, including refreshing tokens using axios request interceptors.","cover_image":"2022-02-21.jpg","cover_image_alt":"a cat taking a very cozy nap","tags":"tutorial, javascript, nextjs"},"markdownBody":"\n_It's the beginning of 2022, and before I dive into this tech filled post, I just wanted to start off cozy and calm. With this amazing picture by Aleksandar Cvetianovic. Take it in. Breathe... and let's go._\n\nPhoto by [Aleksandar Cvetanovic](https://unsplash.com/@lemonzandtea?utm_source=unsplash\u0026utm_medium=referral\u0026utm_content=creditCopyText) on [Unsplash](https://unsplash.com/s/photos/cozy?utm_source=unsplash\u0026utm_medium=referral\u0026utm_content=creditCopyText)\n\n## TL;DR\n\nIn this article, we're going to look into storing and managing refreshing authentication tokens from third-party API's using Next.js. We'll use [HttpOnly cookies](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#restrict_access_to_cookies) and deal with expiring tokens using [axios interceptors](https://axios-http.com/docs/interceptors). Scroll down to \"The setup\" for all the details.\n\n## Background\n\nLast year I was working on a personal project where I was using a third-party API. I researched ways in which I could store the user access token **without** having to create my own database. One of the possibilities was using HttpOnly cookies. I had already decided to go for Next.js because of the quick server setup that comes with it. I implemented the authentication flow and searched for the logic to refresh tokens. This is how I solved it:\n\n## The setup\n\n### Preface\n\nTo follow along, you need to already know how to do the following:\n\n- [set up a Next.js project](https://nextjs.org/docs/getting-started)\n- authenticate the third-party API you're going to use through [Next.js API routes](https://nextjs.org/docs/api-routes/introduction).\n- understand the logic to refresh your tokens for your third-party API.\n\n### Storing your refresh token inside a HttpOnly cookie\n\nTo securely store the third-party API refresh token, we'll use a HttpOnly cookie. To read more about the security they can provide, [check out the docs at MDN.](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#restrict_access_to_cookies).\n\n\u003e **To figure out yourself:**\n\u003e\n\u003e To start, make sure you have your Next.js project setup with a server that manages getting the refresh token from your third-party API. I'm assuming you've created your own endpoint in the `pages/api` folder. For this example, I'll call the file `getRefreshToken.js`.\n\nWe're going to use the [cookie](https://www.npmjs.com/package/cookie) library to help deal with setting our cookie. To add it to our project:\n\n```shell\n$ npm install cookie\n\n// or\n\n$ yarn add cookie\n\n```\n\nWe will create our cookie in the `getRefreshToken.js` file. After getting your refresh token, use the `res` parameter that is exposed from the request handler in the `get-token` endpoint.\n\n```js\n// pages/api/getRefreshToken.js\n\n// --- all the logic you wrote yourself to get the refresh_token\n\nres.setHeader('Set-Cookie', [\n  cookie.serialize('refreshToken', refresh_token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV !== 'development',\n    maxAge: 60 * 60 * 24,\n    sameSite: 'strict',\n    path: '/'\n  })\n]);\n```\n\nTo enable the cookie as HttpOnly, we set `httpOnly: true`. To only allow access through HTTPS protocol, add `secure: process.env.NODE_ENV !== 'development'`. Currently, HTTPS is usually not used on `localhost`, so we set it up to only use `secure: true` on production. If you're curious about this, you can [read up on it on MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#restrict_access_to_cookies).\n\nSet `maxAge: 60 * 60 * 24`, to define the amount of seconds before the cookie expires. In this case it sets it to 24 hours. This will force the token to be invalidated after 24 hours.\n\nEventually the endpoint will look something like this:\n\n```js\n// pages/api/getRefreshToken.js\nimport axios from 'axios';\nimport cookie from 'cookie';\n\nconst getRefreshToken = async (req, res) =\u003e {\n  // we use this 'res' parameter to set the cookie.\n\n  // any logic you need to get your refresh token, including\n\n  const options = {\n    // all necessary options for getting the refresh token\n  };\n\n  const fetchData = () =\u003e\n    axios(options)\n      .then(async response =\u003e {\n        const { refresh_token } = response.data;\n\n        res.setHeader('Set-Cookie', [\n          cookie.serialize('refreshToken', refresh_token, {\n            httpOnly: true,\n            secure: process.env.NODE_ENV !== 'development',\n            maxAge: 60 * 60 * 24,\n            sameSite: 'strict',\n            path: '/'\n          })\n        ]);\n\n        res.statusCode = 200;\n        res.setHeader('Content-Type', 'application/json');\n        res.end(JSON.stringify({ refresh_token }));\n      })\n      .catch(error =\u003e {\n        // logic for handling errors\n      });\n\n  await fetchData();\n};\n\nexport default getRefreshToken;\n```\n\nIf you ever want to use this cookie, you can find it on the `req` object on any call to your Next.js server. It will be available in `req.cookies`.\n\n### Encrypting our refresh token\n\nBecause a refresh token is an important part of the authentication flow, we'll add an extra layer of security by encrypting it. We will use the library [`crypto-js`](https://www.npmjs.com/package/crypto-js) for this. This library can help us encrypt our token using an 'encryption key' or password. This password will only be available to our server. This way the server is able to encrypt and decrypt the token.\n\n```shell\n$ npm install crypto-js\n\n// or\n\n$ yarn add crypto-js\n\n```\n\nIn our `env.local` file (which we do not commit!) we add an environment variable with a encryption key of approximately 32 characters. Make sure this key is truly secret, random and secure!\n\n```env\n// .env.local\nENCRYPT_KEY=theverylongpasswordwith32characters\n```\n\nIn the `getRefreshToken.js` file, import `AES` from `crypto-js/aes`. In the object where we set `refreshToken`, use the `encode` key in the cookie object to pass the function that will encrypt the token:\n\n```js\n// pages/api/getRefreshToken.js\n\nimport AES from 'crypto-js/aes';\n\n// ...\n\ncookie.serialize('refreshToken', refresh_token, {\n  httpOnly: true,\n  secure: process.env.NODE_ENV !== 'development',\n  maxAge: 60 * 60 * 24,\n  sameSite: 'strict',\n  path: '/',\n  encode: value =\u003e AES.encrypt(value, process.env.ENCRYPT_KEY).toString()\n});\n```\n\nWhenever you want to use this token you do need to decrypt it using the encryption key like so:\n\n```js\nimport CryptoJS from 'crypto-js';\n\n// In the place where you use your refresh token:\nconst { refreshToken } = req.cookies;\nconst decryptedRefresh = CryptoJS.AES.decrypt(\n  refreshToken,\n  process.env.ENCRYPT_KEY\n).toString(CryptoJS.enc.Utf8);\n```\n\n### Setting up an axios instance to manage refresh tokens\n\nWhenever a token expires or is incorrect, we'll try and refresh them. Usually, in the cases that this happens, an API would return [`401 Unauthorized`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/401).\n\nTo deal with this we're going to use [axios Interceptors](https://axios-http.com/docs/interceptors).\n\nYou can use an interceptor to 'intercept' requests or responses before they are actually handled. In this example we're going to:\n\n- Create our own axios instance and add a request and response interceptor to it.\n- Use this axios instance everywhere we are doing calls that use an access token.\n\nThis way, if an endpoint is using an access token to get data, and receives an `401 Unauthorized`, we can handle this by refreshing the token. Let's break this down:\n\nCreate your own axios instance inside a file called `axios-instance.js`:\n\n```js\n// axios-instance.js\nimport axios from 'axios';\n\nconst axiosInstance = axios.create();\n\nexport default axiosInstance;\n```\n\nTo add our interceptor logic we'll start with the response interceptor. Whenever we get a response from an API we check if it is `401 Unauthorized`. If that is the case we refresh the access token and try the call again. To do this we'll be using [axios-auth-refresh](https://www.npmjs.com/package/axios-auth-refresh) which makes it really easy to set this up.\n\nAdd the library:\n\n```js\nnpm install 'axios-auth-refresh'\n\n// or\n\nyarn add 'axios-auth-refresh'\n\n```\n\nInside the `axios-instance.js` file, import `createAuthRefreshInterceptor`. Then create a `refreshAuthLogic` function. This function has a failedRequest parameter that we receive from our interceptor.\n\n\u003e **To figure out yourself:**\n\u003e\n\u003e Now it's up to you to create a function we can call that handles refreshing the access token from your third-party API. You can grab the refresh token from `req.cookies`. Don't forget to decrypt it like I showed you before! And make sure it returns the access token __without__ encryption.\n\nInside `refreshAuthLogic` we will use the refresh function you created yourself, in this example it's called `refreshAccessToken`. That function returns our new token, which we set as the response Authorization header. Finally, we return a resolved promise.\n\nWe then call the `createAuthRefreshInterceptor` function and pass in the `axiosInstance` and `refreshAuthLogic` function we created.\n\n```js\n// axios-instance.js\nimport axios from 'axios';\nimport createAuthRefreshInterceptor from 'axios-auth-refresh';\nimport refreshAccessToken from './refresh-access-token'; // this file contains any logic you need to refresh your token with your third-party API\n\nconst axiosInstance = axios.create();\n\nconst refreshAuthLogic = failedRequest =\u003e\n  refreshAccessToken().then(tokenRefreshResponse =\u003e {\n    // get the new token\n    failedRequest.response.config.headers.Authorization = `Bearer ${tokenRefreshResponse.accessToken}`; // set the new token as the authorization header.\n    return Promise.resolve();\n  });\n\ncreateAuthRefreshInterceptor(axiosInstance, refreshAuthLogic);\n\nexport default axiosInstance;\n```\n\n\u003e **To figure out yourself:**\n\u003e\n\u003e Something to keep in mind for the `refreshAccessToken` logic that you'll be creating yourself to get your refreshed token, is that you're going to have to make sure you also set this new refresh token as a cookie. You can use the same logic as we have used before for that.\n\nNow let's deal with the request interceptors. This is where the fun starts.\n\nInside our `axios-instance.js` file, we're going to create a `let requestToken;` empty variable. Then inside `refreshAuthLogic`, we assign the refreshed token to `requestToken`. This way, `requestToken` will always be up to date with the latest version of our token.\n\nAfter this we're going to set our own request interceptor. We tell it to check if `requestToken` is empty or not. If it is empty, we'll use the `refreshAccessToken` function to get a new token. If it is not empty, we use `requestToken` as our authorization header:\n\n```js\n// axios-instance.js\nimport axios from 'axios';\nimport createAuthRefreshInterceptor from 'axios-auth-refresh';\nimport refreshAccessToken from './refresh-access-token';\n\nlet requestToken;\n\nconst axiosInstance = axios.create();\n\nconst refreshAuthLogic = failedRequest =\u003e\n  refreshAccessToken().then(tokenRefreshResponse =\u003e {\n    failedRequest.response.config.headers.Authorization = `Bearer ${tokenRefreshResponse.accessToken}`;\n    requestToken = tokenRefreshResponse.accessToken; // change the requestToken with the refreshed one\n    return Promise.resolve();\n  });\n\ncreateAuthRefreshInterceptor(axiosInstance, refreshAuthLogic);\n\naxiosInstance.interceptors.request.use(async request =\u003e {\n  if (!requestToken) {\n    refreshAccessToken().then(tokenRefreshResponse =\u003e {\n      requestToken = tokenRefreshResponse.accessToken;\n    });\n  }\n\n  request.headers.Authorization = `Bearer ${requestToken}`;\n  return request;\n});\n\nexport default axiosInstance;\n```\n\nFrom this point on, any request that is made using the axios instance, will grab the authorization token from the `let requestToken` in this file _before_ doing a request. So if an earlier request refreshed the token, the next one is able to use the refreshed one. And that's it!\n","date":"February 21, 2022","slug":"nextjs-auth-with-httponly-cookies-incl-refresh","image":"https://khendrikse.github.io/_next/static/chunks/images/2022-02-21-a75a39c7f14850cc4cdf9e10a5fc635f.jpg"},"__N_SSG":true},"page":"/blog/[postname]","query":{"postname":"nextjs-auth-with-httponly-cookies-incl-refresh"},"buildId":"OhLvGett58GshWm6RiLAE","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>